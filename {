Script started on 2025-11-23 17:38:23+00:00 [TERM="xterm" TTY="/dev/pts/2" COLUMNS="210" LINES="58"]
[?2004h]0;ubuntu@ip-172-31-26-121: ~/GuviProject-devops-buildubuntu@ip-172-31-26-121:~/GuviProject-devops-build$ git push# push to GitHubgit commit -m "Add build folder for static deployment"[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[34P# commit the changes[7Pgit add build[K[K[K[K[K[K[K[K[K[K[K[K[Kcat Jenkinsfile
[?2004lpipeline {
  agent any

  environment {
    DOCKERHUB_CRED = 'dockerhub-creds'
    SSH_CRED = 'ssh-app-server'
    APP_SERVER = 'ubuntu@13.60.220.253'
    DOCKERHUB_USER = 'jegadeeshanjeggy'
    IMAGE_NAME = 'dev-app'
  }

  stages {

    stage('Build & Push Docker Image') {
      steps {
        script {
          def sha = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          def envType = (env.BRANCH_NAME == 'dev') ? 'dev' : 'prod'

          def tagName = "${DOCKERHUB_USER}/${IMAGE_NAME}:${envType}-${sha}"
          def latestName = "${DOCKERHUB_USER}/${IMAGE_NAME}:${envType}"

          sh "docker build -t ${tagName} -t ${latestName} ."

          withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CRED}", usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
            sh "echo $DH_PASS | docker login --username $DH_USER --password-stdin"
          }

          sh "docker push ${tagName}"
          sh "docker push ${latestName}"

          writeFile file: 'imagename.txt', text: tagName
          archiveArtifacts artifacts: 'imagename.txt'
        }
      }
    }

    stage('Deploy to App Server') {
      steps {
        script {
          def image = readFile('imagename.txt').trim()

          sshagent(credentials: [SSH_CRED]) {
            sh """
		ssh -o StrictHostKeyChecking=no ${APP_SERVER} <<EOF
			docker pull ${image}
			sed -i "s|image:.*|image: ${image}|g" /opt/production-app/docker-compose.yml
			cd /opt/production-app
			docker compose up -d --remove-orphans
		EOF
            """
          }
        }
      }
    }
  }

  post {
    success {
      echo "Pipeline completed successfully."
    }
    failure {
      echo "Pipeline failed!"
    }
  }
}

[?2004h]0;ubuntu@ip-172-31-26-121: ~/GuviProject-devops-buildubuntu@ip-172-31-26-121:~/GuviProject-devops-build$ vi Jenkinsfile
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;58r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[58;1H"Jenkinsfile" 67L, 1737B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;1Hpipeline {
  agent [36many[m[2;12H[K[3;1H[K[4;3Henvironment {
    DOCKERHUB_CRED = [31m'dockerhub-creds'[m
    SSH_CRED = [31m'ssh-app-server'[m
    APP_SERVER = [31m'ubuntu@13.60.220.253'[m
    DOCKERHUB_USER = [31m'jegadeeshanjeggy'[m
    IMAGE_NAME = [31m'dev-app'[m
  }

  stages {[14;5Hstage([31m'Build & Push Docker Image'[m) {[15;7Hsteps {[16;9Hscript {[17;11H[35mdef[m sha = sh(returnStdout: [31mtrue[m, script: [31m'git rev-parse --short HEAD'[m).trim()[18;11H[35mdef[m envType = (env.BRANCH_NAME == [31m'dev'[m) ? [31m'dev'[m : [31m'prod'[m[20;11H[35mdef[m tagName = [31m"[m[36m${DOCKERHUB_USER}[m[31m/[m[36m${IMAGE_NAME}[m[31m:[m[36m${envType}[m[31m-[m[36m${sha}[m[31m"[m[21;11H[35mdef[m latestName = [31m"[m[36m${DOCKERHUB_USER}[m[31m/[m[36m${IMAGE_NAME}[m[31m:[m[36m${envType}[m[31m"[m[23;11Hsh [31m"docker build -t [m[36m${tagName}[m[31m -t [m[36m${latestName}[m[31m ."[m[25;11HwithCredentials([usernamePassword(credentialsId: [31m"[m[36m${DOCKERHUB_CRED}[m[31m"[m, usernameVariable: [31m'DH_USER'[m, passwordVariable: [31m'DH_PASS'[m)]) {[26;13Hsh [31m"echo [m[36m$DH_PASS[m[31m | docker login --username [m[36m$DH_USER[m[31m --password-stdin"[m[27;11H}[29;11Hsh [31m"docker push [m[36m${tagName}[m[31m"[m[30;11Hsh [31m"docker push [m[36m${latestName}[m[31m"[m[32;11HwriteFile file: [31m'imagename.txt'[m, text: tagName[33;11HarchiveArtifacts artifacts: [31m'imagename.txt'[m[34;9H}[35;7H}
    }[38;5Hstage([31m'Deploy to App Server'[m) {[39;7Hsteps {[40;9Hscript {[41;11H[35mdef[m image = readFile([31m'imagename.txt'[m).trim()[43;11Hsshagent(credentials: [SSH_CRED]) {[44;13Hsh [31m"""
                ssh -o StrictHostKeyChecking=no [m[36m${APP_SERVER}[m[31m <<EOF
                        docker pull [m[36m${image}[m
[31m                        sed -i "s|image:.*|image: [m[36m${image}[m[31m|g" /opt/production-app/docker-compose.yml
                        cd /opt/production-app
                        docker compose up -d --remove-orphans
                EOF
            """[m[52;11H}[53;9H}[54;7H}
    }
  }[58;193H50,5-19[7CTop[50;19H[?25h[?4m[?12$p[?25l[58;183H0[50;19H[58;184H0[50;19H[58;185H0[50;19H[58;186H/[50;19H[58;187H0[50;19H[58;188H0[50;19H[58;189H0[50;19H[58;190H0[50;19H[58;191H/[50;19H[58;192H0[50;19H[58;183H          [50;19H[27m[23m[29m[m[H[2J[1;1Hpipeline {
  agent [1m[36many[m

  environment {
    DOCKERHUB_CRED = [1m[35m'dockerhub-creds'[m
    SSH_CRED = [1m[35m'ssh-app-server'[m
    APP_SERVER = [1m[35m'ubuntu@13.60.220.253'[m
    DOCKERHUB_USER = [1m[35m'jegadeeshanjeggy'[m
    IMAGE_NAME = [1m[35m'dev-app'[m
  }

  stages {[14;5Hstage([1m[35m'Build & Push Docker Image'[m) {[15;7Hsteps {[16;9Hscript {[17;11H[1m[31mdef[m sha = sh(returnStdout: [1m[35mtrue[m, script: [1m[35m'git rev-parse --short HEAD'[m).trim()[18;11H[1m[31mdef[m envType = (env.BRANCH_NAME == [1m[35m'dev'[m) ? [1m[35m'dev'[m : [1m[35m'prod'[m[20;11H[1m[31mdef[m tagName = [1m[35m"[m[1m[36m${DOCKERHUB_USER}[m[1m[35m/[m[1m[36m${IMAGE_NAME}[m[1m[35m:[m[1m[36m${envType}[m[1m[35m-[m[1m[36m${sha}[m[1m[35m"[m[21;11H[1m[31mdef[m latestName = [1m[35m"[m[1m[36m${DOCKERHUB_USER}[m[1m[35m/[m[1m[36m${IMAGE_NAME}[m[1m[35m:[m[1m[36m${envType}[m[1m[35m"[m[23;11Hsh [1m[35m"docker build -t [m[1m[36m${tagName}[m[1m[35m -t [m[1m[36m${latestName}[m[1m[35m ."[m[25;11HwithCredentials([usernamePassword(credentialsId: [1m[35m"[m[1m[36m${DOCKERHUB_CRED}[m[1m[35m"[m, usernameVariable: [1m[35m'DH_USER'[m, passwordVariable: [1m[35m'DH_PASS'[m)]) {[26;13Hsh [1m[35m"echo [m[1m[36m$DH_PASS[m[1m[35m | docker login --username [m[1m[36m$DH_USER[m[1m[35m --password-stdin"[m[27;11H}[29;11Hsh [1m[35m"docker push [m[1m[36m${tagName}[m[1m[35m"[m[30;11Hsh [1m[35m"docker push [m[1m[36m${latestName}[m[1m[35m"[m[32;11HwriteFile file: [1m[35m'imagename.txt'[m, text: tagName[33;11HarchiveArtifacts artifacts: [1m[35m'imagename.txt'[m[34;9H}[35;7H}
    }[38;5Hstage([1m[35m'Deploy to App Server'[m) {[39;7Hsteps {[40;9Hscript {[41;11H[1m[31mdef[m image = readFile([1m[35m'imagename.txt'[m).trim()[43;11Hsshagent(credentials: [SSH_CRED]) {[44;13Hsh [1m[35m"""
                ssh -o StrictHostKeyChecking=no [m[1m[36m${APP_SERVER}[m[1m[35m <<EOF
                        docker pull [m[1m[36m${image}[m
[1m[35m                        sed -i "s|image:.*|image: [m[1m[36m${image}[m[1m[35m|g" /opt/production-app/docker-compose.yml
                        cd /opt/production-app
                        docker compose up -d --remove-orphans
                EOF
            """[m[52;11H}[53;9H}[54;7H}
    }
  }[58;193H50,5-19[7CTop"Jenkinsfile" 67L, 1737B[50;19H[?25h[?25l[58;183H^[[50;19H[58;183H  [50;19H[58;183H^[[50;19H[58;183H  [50;19H[?25h[?25l[58;183H:[50;19H[58;1H[K[58;1H:[?25hq![?25l[?2004l[>4;m[23;2t[23;1t[58;1H[K[58;1H[?1004l[?2004l[?1l>[?1049l[23;0;0t[?25h[>4;m[?2004h]0;ubuntu@ip-172-31-26-121: ~/GuviProject-devops-buildubuntu@ip-172-31-26-121:~/GuviProject-devops-build$ rm -rf Jenkinsfile
[?2004l[?2004h]0;ubuntu@ip-172-31-26-121: ~/GuviProject-devops-buildubuntu@ip-172-31-26-121:~/GuviProject-devops-build$ vi JenkinsfileOld [K[K[K[K
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;58r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[58;1H"Jenkinsfile" [New][2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[2;1H[1m[34m~                                                                                                                                                                                                                 [3;1H~                                                                                                                                                                                                                 [4;1H~                                                                                                                                                                                                                 [5;1H~                                                                                                                                                                                                                 [6;1H~                                                                                                                                                                                                                 [7;1H~                                                                                                                                                                                                                 [8;1H~                                                                                                                                                                                                                 [9;1H~                                                                                                                                                                                                                 [10;1H~                                                                                                                                                                                                                 [11;1H~                                                                                                                                                                                                                 [12;1H~                                                                                                                                                                                                                 [13;1H~                                                                                                                                                                                                                 [14;1H~                                                                                                                                                                                                                 [15;1H~                                                                                                                                                                                                                 [16;1H~                                                                                                                                                                                                                 [17;1H~                                                                                                                                                                                                                 [18;1H~                                                                                                                                                                                                                 [19;1H~                                                                                                                                                                                                                 [20;1H~                                                                                                                                                                                                                 [21;1H~                                                                                                                                                                                                                 [22;1H~                                                                                                                                                                                                                 [23;1H~                                                                                                                                                                                                                 [24;1H~                                                                                                                                                                                                                 [25;1H~                                                                                                                                                                                                                 [26;1H~                                                                                                                                                                                                                 [27;1H~                                                                                                                                                                                                                 [28;1H~                                                                                                                                                                                                                 [29;1H~                                                                                                                                                                                                                 [30;1H~                                                                                                                                                                                                                 [31;1H~                                                                                                                                                                                                                 [32;1H~                                                                                                                                                                                                                 [33;1H~                                                                                                                                                                                                                 [34;1H~                                                                                                                                                                                                                 [35;1H~                                                                                                                                                                                                                 [36;1H~                                                                                                                                                                                                                 [37;1H~                                                                                                                                                                                                                 [38;1H~                                                                                                                                                                                                                 [39;1H~                                                                                                                                                                                                                 [40;1H~                                                                                                                                                                                                                 [41;1H~                                                                                                                                                                                                                 [42;1H~                                                                                                                                                                                                                 [43;1H~                                                                                                                                                                                                                 [44;1H~                                                                                                                                                                                                                 [45;1H~                                                                                                                                                                                                                 [46;1H~                                                                                                                                                                                                                 [47;1H~                                                                                                                                                                                                                 [48;1H~                                                                                                                                                                                                                 [49;1H~                                                                                                                                                                                                                 [50;1H~                                                                                                                                                                                                                 [51;1H~                                                                                                                                                                                                                 [52;1H~                                                                                                                                                                                                                 [53;1H~                                                                                                                                                                                                                 [54;1H~                                                                                                                                                                                                                 [55;1H~                                                                                                                                                                                                                 [56;1H~                                                                                                                                                                                                                 [57;1H~                                                                                                                                                                                                                 [m[58;193H0,0-1[9CAll[1;1H[?25h[?4m[?12$p[?25l[58;183H0[1;1H[58;184H0[1;1H[58;185H0[1;1H[58;186H/[1;1H[58;187H0[1;1H[58;188H0[1;1H[58;189H0[1;1H[58;190H0[1;1H[58;191H/[1;1H[58;192H0[1;1H[58;183H          [1;1H[27m[23m[29m[m[H[2J[2;1H[1m[34m~                                                                                                                                                                                                                 [3;1H~                                                                                                                                                                                                                 [4;1H~                                                                                                                                                                                                                 [5;1H~                                                                                                                                                                                                                 [6;1H~                                                                                                                                                                                                                 [7;1H~                                                                                                                                                                                                                 [8;1H~                                                                                                                                                                                                                 [9;1H~                                                                                                                                                                                                                 [10;1H~                                                                                                                                                                                                                 [11;1H~                                                                                                                                                                                                                 [12;1H~                                                                                                                                                                                                                 [13;1H~                                                                                                                                                                                                                 [14;1H~                                                                                                                                                                                                                 [15;1H~                                                                                                                                                                                                                 [16;1H~                                                                                                                                                                                                                 [17;1H~                                                                                                                                                                                                                 [18;1H~                                                                                                                                                                                                                 [19;1H~                                                                                                                                                                                                                 [20;1H~                                                                                                                                                                                                                 [21;1H~                                                                                                                                                                                                                 [22;1H~                                                                                                                                                                                                                 [23;1H~                                                                                                                                                                                                                 [24;1H~                                                                                                                                                                                                                 [25;1H~                                                                                                                                                                                                                 [26;1H~                                                                                                                                                                                                                 [27;1H~                                                                                                                                                                                                                 [28;1H~                                                                                                                                                                                                                 [29;1H~                                                                                                                                                                                                                 [30;1H~                                                                                                                                                                                                                 [31;1H~                                                                                                                                                                                                                 [32;1H~                                                                                                                                                                                                                 [33;1H~                                                                                                                                                                                                                 [34;1H~                                                                                                                                                                                                                 [35;1H~                                                                                                                                                                                                                 [36;1H~                                                                                                                                                                                                                 [37;1H~                                                                                                                                                                                                                 [38;1H~                                                                                                                                                                                                                 [39;1H~                                                                                                                                                                                                                 [40;1H~                                                                                                                                                                                                                 [41;1H~                                                                                                                                                                                                                 [42;1H~                                                                                                                                                                                                                 [43;1H~                                                                                                                                                                                                                 [44;1H~                                                                                                                                                                                                                 [45;1H~                                                                                                                                                                                                                 [46;1H~                                                                                                                                                                                                                 [47;1H~                                                                                                                                                                                                                 [48;1H~                                                                                                                                                                                                                 [49;1H~                                                                                                                                                                                                                 [50;1H~                                                                                                                                                                                                                 [51;1H~                                                                                                                                                                                                                 [52;1H~                                                                                                                                                                                                                 [53;1H~                                                                                                                                                                                                                 [54;1H~                                                                                                                                                                                                                 [55;1H~                                                                                                                                                                                                                 [56;1H~                                                                                                                                                                                                                 [57;1H~                                                                                                                                                                                                                 [m[58;193H0,0-1[9CAll"Jenkinsfile" [New][1;1H[?25h[?25l[58;1H[1m-- INSERT --[m[58;13H[K[58;193H0,1[11CAll[1;1Hpipeline {
  agent [1m[36many[m[2;12H[K[3;1H[K[4;1H[K[4;1H[?25h[?25l  environment {
    DOCKERHUB_CRED = [1m[35m'dockerhub-creds'[m[5;39H[K[6;1H[K[6;1H[?25h[?25l    SSH_CRED[7C= [1m[35m'ssh-app-server'[m
    APP_SERVER     =[7;21H[K[7;21H[?25h[?25l [1m[35m'ubuntu@13.60.220.253'[m[8;1H[K[8;1H[?25h[?25l    DOCKERHUB_USER = [1m[35m'jegadeeshanjeggy'[m
    IMAGE_NA[9;13H[K[9;13H[?25h[?25lME     = [1m[35m'dev-app'[m[10;1H[K[10;1H[?25h[?25l  }[11;1H[K[11;1H[?25h[?25l
  stages {[12;11H[K[13;1H[K[14;1H[K[14;1H[?25h[?25l    stage([1m[35m'Build & Push Docker Image'[m) {
      steps {[15;14H[K[16;1H[K[16;1H[?25h[?25l[8Cscript {[17;1H[K[17;1H[?25h[?25l[10C[1m[31mdef[m sha = sh(returnStdout: [1m[35mtrue[m, script: [1m[35m'git rev-pa[?25h[?25lrse --short HEAD'[m).trim()
          [1m[31mdef[m envType = (env.BRANCH_[18;37H[K[18;37H[?25h[?25lNAME == [1m[35m'dev'[m) ? [1m[35m'dev'[m : [1m[35m'prod'[m[19;1H[K[19;1H[?25h[?25l
          [1m[31mdef[m tagName   = [1m[35m"[m[1m[36m${DOCKERHUB_USER}[m[1m[35m/${IMAG[m[20;52H[K[20;52H[?25h[?25l[1m[36m${IMAGE_NAME}[m[1m[35m:[m[1m[36m${envType}[m[1m[35m-[m[1m[36m${sha}[m[1m[35m"[m[21;1H[K[21;1H[?25h[?25l[10C[1m[31mdef[m latestTag = [1m[35m"[m[1m[36m${DOCKERHUB_USER}[m[1m[35m/[m[1m[36m${IMAGE_NAME}[m[1m[35m:${envTyp[?25h[?25l[m[21;60H[1m[36m${envType}[m[1m[35m"[m[22;1H[K[23;1H          sh [1m[35m"docker build -t [m[1m[36m${tagName}[m[1m[35m -t [m[1m[36m${latestTag}[m[1m[35m ."[m[23;60H[K[24;1H[K[24;1H[?25h[?25l
          withCredentials([usernamePassword(credentialsId: DOCKE[25;65H[K[25;65H[?25h[?25lRHUB_CRED, usernameVariable: [1m[35m'DH_USER'[m, passwordVariable: [1m[35m'DH_PAS[?25h[?25lS'[m)]) {[26;1H[K[26;1H[?25h[?25l[12Csh [1m[35m"echo [m[1m[36m$DH_PASS[m[1m[35m | docker login --username [m[1m[36m$DH_U[?25h[?25lSER[m[1m[35m --password-stdin"[m[27;1H[K[27;1H[?25h[?25l[10C}[28;1H[K[28;1H[?25h[?25l
          sh [1m[35m"docker push [m[1m[36m${tagName}[m[1m[35m"[m[29;38H[K[30;1H          sh[30;13H[K[30;13H[?25h[?25l [1m[35m"docker push [m[1m[36m${latestTag}[m[1m[35m"[m[31;1H[K[31;1H[?25h[?25l[32;1H[K[32;1H[?25h[?25l[10CwriteFile file: [1m[35m'imagename.txt'[m, text: tagName[33;1H[K[33;1H[?25h[?25l[10CarchiveArtifacts artifacts: [1m[35m'imagename.txt'[m
        }[34;10H[K[35;1H    [35;5H[K[35;5H[?25h[?25l  }[36;1H[K[36;1H[?25h[?25l    }[37;1H[K[38;1H    stage([1m[35m'Deploy to App Server'[m) {[38;36H[K[39;1H[K[39;1H[?25h[?25l      steps {
        script {[40;17H[K[41;1H          [1m[31mdef[m image [41;21H[K[41;21H[?25h[?25l= readFile([1m[35m'imagename.txt'[m).trim()[42;1H[K[42;1H[?25h[?25l
          sshagent(credentials: [SSH_CRED]) {[43;46H[K[44;1H[K[44;1H[?25h[?25l[45;1H[K[45;1H[?25h[?25l[12Csh [1m[35m"""[m[46;1H[K[46;1H[?25h[?25l[1m[35mssh -o StrictHostKeyChecking=no [m[1m[36m${APP_SERVER}[m[1m[35m <<EOF
docker pull[m[47;12H[K[47;12H[?25h[?25l[1m[35m [m[1m[36m${image}[m[48;1H[K[48;1H[?25h[?25l[1m[35msed -i "s|image:.*|image: [m[1m[36m${image}[m[1m[35m|g" /opt/production-app/d[?25h[?25locker-compose.yml[m[49;1H[K[49;1H[?25h[?25l[1m[35mcd /opt/production-app
docker compose up -d --remove-or[m[50;33H[K[50;33H[?25h[?25l[1m[35mphans
EOF